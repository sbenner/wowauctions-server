<html lang="en" xml:lang="en">
<head>

    <meta id="_csrf" name="_csrf" content="${_csrf.token}"/>
    <!-- default header name is X-CSRF-TOKEN -->
    <meta id="_csrf_header" name="_csrf_header" content="${_csrf.headerName}"/>
    <!-- Plotly.js -->
    <!-- Latest compiled and minified plotly.js JavaScript -->
    <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
            integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
            crossorigin="anonymous"></script>
    <!-- Fonts -->
    <link href="//fonts.googleapis.com/css?family=Open+Sans:600,400,300,200|Inconsolata|Ubuntu+Mono:400,700"
          rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <!-- code highlighting -->
    <link rel="stylesheet" href="//plot.ly/gh-pages/documentation/static/javascripts/codehighlight/styles/tomorrow.css">
    <link rel="stylesheet" type="text/css" href="//plot.ly/gh-pages/documentation/static/css/js-splash-highlight.css"/>

    <!-- Main Stylesheets -->
    <link rel="stylesheet" type="text/css" href="https://images.plot.ly/assets/css/normalize.css">
    <link rel="stylesheet" type="text/css"
          href="https://plot.ly/gh-pages/documentation/static//css/main.css?version=66c7ea55d3">

</head>

<body>
<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
<div id="myDiv"><!-- Plotly chart will be drawn inside this DIV --></div>
<script>

    window.onload = function () {

        $.ajax({
            type: "OPTIONS",
            url: "http://localhost:8080/",
            cache: false,
            success: function (data, opts, xhr) {
                console.log(xhr.getAllResponseHeaders());

                //   $.ajaxPrefilter(function (options, originalOptions, jqXHR) {
                var token = xhr.getResponseHeader('X-CSRF-TOKEN');
                runReq(token)


            },
            error: function (data) {
                console.log(data.statusText);
            }
        });


        var dt = [];

        var avg = function (arr) {
            var sum = arr.reduce(function (a, b) {
                return a + b;
            });
            return sum / arr.length;
        };


        Array.prototype.groupBy = function (prop) {
            return this.reduce(function (groups, item) {
                var val = item[prop];
                groups[val] = groups[val] || [];
                groups[val].push(item.y);
                return groups;
            }, {});
        };

//        //function to be executed before an Ajax request is sent.
        function runReq(token) {

            $(document).ajaxSend(function (e, xhr, options) {
                var header = "X-CSRF-TOKEN";
                xhr.setRequestHeader(header, token);
            });
            $.ajax({
                type: "GET",
                url: "http://localhost:8080/wow/v1/web/itemchart?id=123914",
                cache: false,
                success: function (data) {
                    for (var p in data) {
                        if (data.hasOwnProperty(p)) {

                            dt.push({
                                x: $.datepicker.formatDate('yy-mm-dd',
                                    new Date(data[p])), y: parseInt(p)
                            });
                        }
                    }

                    var layout = {
                        title: 'Item Prices'
                    };

                    var grouped = dt.groupBy('x');

                    var dt1 = {mode: 'markers', x: [], y: []};
                    for (p in grouped) {
                        dt1.x.push(p);
                        dt1.y.push(avg(grouped[p]) / 1000);
                    }

                    console.log(dt1);
                    Plotly.newPlot('myDiv', [dt1]);
                    // $("#resultarea").text(data);
                },
                error: function (data) {
                    console.log(data.statusText);
                }
            });


        }

    }
</script>

</body>
</html>
</jsp:root>