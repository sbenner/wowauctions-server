<html lang="en" xml:lang="en">
<head>
    <link rel="shortcut icon" href="#"/>
    <meta id="_csrf" name="_csrf" content="${_csrf.token}"/>
    <!-- default header name is X-CSRF-TOKEN -->
    <meta id="_csrf_header" name="_csrf_header" content="${_csrf.headerName}"/>
    <!-- Plotly.js -->
    <!-- Latest compiled and minified plotly.js JavaScript -->
    <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
            integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
            crossorigin="anonymous"></script>
    <!-- Fonts -->
    <link href="//fonts.googleapis.com/css?family=Open+Sans:600,400,300,200|Inconsolata|Ubuntu+Mono:400,700"
          rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <!-- code highlighting -->
    <link rel="stylesheet" href="//plot.ly/gh-pages/documentation/static/javascripts/codehighlight/styles/tomorrow.css">
    <link rel="stylesheet" type="text/css" href="//plot.ly/gh-pages/documentation/static/css/js-splash-highlight.css"/>
    <link rel='stylesheet' type='text/css' media='all' href='wow.css' />
    <!-- Main Stylesheets -->
    <link rel="stylesheet" type="text/css" href="https://images.plot.ly/assets/css/normalize.css">
    <link rel="stylesheet" type="text/css"
          href="https://plot.ly/gh-pages/documentation/static//css/main.css?version=66c7ea55d3">

    <style>
        .item {
            background-color: black;
        }
        .tooltip {
            background-color: black;
        }
        body {
            background-color: black;
            color: lightgrey;
        }
        a {
            text-decoration: none;
            background-color: none;
            color: gray;
        }
    </style>

</head>

<br>
<input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
<div id="myDiv" style="width: 70%"><!-- Plotly chart will be drawn inside this DIV --></div>
<script>

    window.myJsonpCallback = function(data) {
      console.log(data);
    };

    window.onload = function () {

        $.ajax({
            type: "OPTIONS",
            url: "http://localhost:8080/",
            cache: false,
            success: function (data, opts, xhr) {
                console.log(xhr.getAllResponseHeaders());

                //   $.ajaxPrefilter(function (options, originalOptions, jqXHR) {
                var token = xhr.getResponseHeader('X-CSRF-TOKEN');
                //runReq(token)


            },
            error: function (data) {
                console.log(data.statusText);
            }
        });


        var dt = [];

        var avg = function (arr) {
            var sum = arr.reduce(function (a, b) {
                return a + b;
            });
            var result = Math.round(sum / arr.length);
            var price = result.toString();
            var len = price.length;

            if (len > 4) {
                price = price.substr(0, len - 4) + "g"
                    + price.substr(len - 2, len) + "s" + price.substr(len - 2, len) + "c";
            }
            if (len > 2 && len <= 4) {
                price = price.substr(0, len - 2) + "s" + price.substr(len - 2, len) + "c";
            }
            if (len <= 2) {
                price = price.substr(0, len) + "c";
            }

            return price;
        };


        Array.prototype.groupBy = function (prop) {
            return this.reduce(function (groups, item) {
                var val = item[prop];
                groups[val] = groups[val] || [];
                groups[val].push(item.y);
                return groups;
            }, {});
        };

//        //function to be executed before an Ajax request is sent.
        function runReq(token) {

            $(document).ajaxSend(function (e, xhr, options) {
                var header = "X-CSRF-TOKEN";
                xhr.setRequestHeader(header, token);
            });
            $.ajax({
                type: "GET",
                url: "http://localhost:8080/wow/v1/web/itemchart?id=123914",
                cache: false,
                success: function (data) {
                    for (var p in data) {
                        if (data.hasOwnProperty(p)) {

                            dt.push({
                                x: $.datepicker.formatDate('yy-mm-dd',
                                    new Date(data[p])), y: parseInt(p)
                            });
                        }
                    }

                    var layout = {
                        title: 'Item Prices'
                    };

                    var grouped = dt.groupBy('x');

                    var dt1 = {mode: 'markers+lines', x: [], y: []};
                    for (p in grouped) {
                        dt1.x.push(p);
                        dt1.y.push(avg(grouped[p]));
                    }

                    console.log(dt1);
                    Plotly.newPlot('myDiv', [dt1]);
                    // $("#resultarea").text(data);
                },
                error: function (data) {
                    console.log(data.statusText);
                }
            });


        }

        function createCORSRequest(method, url){
            var xhr = new XMLHttpRequest();
            if ("withCredentials" in xhr){
                xhr.open(method, url, true);
            } else if (typeof XDomainRequest != "undefined"){
                xhr = new XDomainRequest();
                xhr.open(method, url);
            } else {
                xhr = null;
            }
            return xhr;
        }

        function getItemFromWeb(id) {

           var req= createCORSRequest("GET","http://us.battle.net/wow/en/item/" + id+ "/tooltip");

            if (req){
                req.onload = function(){
                    console.log(req.responseText);
                    //do something with request.responseText
                };
                req.send();
            }


//
//            $.ajax( {
//                url:"http://us.battle.net/wow/en/item/" + id+ "/tooltip?format=jsonp",
//                crossOrigin:true,
//                jsonpCallback:'myJsonMethod',
//                accepts: {
//                    mycustomtype: 'text/html'
//                },
//                headers: {"Content-Type":"text/plain; charset=utf-8", "Accept": "*"},
//                converters: {
//                    'text mycustomtype': function(result) {
//                        // Do Stuff
//                        console.log(result);
//                        return newresult;
//                    }
//                },
//                dataType: 'jsonp',
//
//                success: function(result){
//
//                  console.log(result);
//
//                },
//
//                error: function(result){
//
//                    console.log("Error"+result);
//
//                },
//
//            });

//          $.get("http://us.battle.net/wow/en/item/" + id+ "/tooltip",function (data,err) {
//             console.log(data);
//              console.log(err);
//          });

//         $.ajax({
//                type: "GET",
//                url: "http://us.battle.net/wow/en/item/" + id+ "/tooltip",
//                crossDomain: true,
//                crossOrigin: true,
//
//                jsonpCallback:'myJsonMethod',
//                dataType: 'jsonp',
//                jsonp:'jsonp',
//                cache: false,
//                success: function (data,d1,d2) {
//                    var html = $.parseHTML(data);
//                    var el=document.getElementsByClassName('tooltip');
//                    el.htmlText=html;
//                },
//                error: function (data,d1,d2) {
//
//                    data.responseType = 'text';
//
//                    data.success(function (a,b,c) {
//                       console.log(a);
//                        console.log(b);
//                        console.log(c);
//                    });
//
//                    console.log(data.statusText);
//                }
//            });
        }

        function runGetitems(name) {

            name = name.trim();
            $.ajax({
                type: "GET",
                url: "http://localhost:8080/wow/v1/web/items?name=" + name,
                cache: false,
                crossDomain: true,
                success: function (data) {
                    if (data.numberOfElements > 0) {
                        $("#table tbody").text("");
                        $("#tbl").show();
                        $.each(data.content, function (d, results) {


                            $("#table tbody").append(
                                "<tr>" +
                                "<td><a id=\""+results.item.id+"\" onmouseover='' href=\"#"
                                + results.item.id + "\">" +
                                "<div class='item'>" + results.item.name + "</div>" +
                                "<div class='tooltip'></div></a></td>" +
                                "<td>" + results.item.itemLevel + "</td>" +
                                "<td>" + results.owner + "</td>" +
                                "<td>" + results.bid + "</td>" +
                                "<td>" + results.buyout + "</td>" +
                                "<td>" + results.ppi + "</td>" +
                                "<td>" + results.quantity + "</td>" +
                                "</tr>"
                            );
                            setAhrefColor(results.item);

                        });
                    }
                },
                error: function (data) {
                    console.log(data.statusText);
                }
            });


        }

        function setAhrefColor(item) {
            var quality = item.quality;
            var ahref = document.getElementById(item.id);

            if (ahref && ahref !== null) {
                ahref.onmouseover = getItemFromWeb(item.id);
            //    ahref.addEventListener("mouseover", getItemFromWeb(item.id));

                if (quality === 1) {
                    ahref.style.color = '#ffffff';
                }
                else if (quality === 2) {
                    ahref.style.color = '#1eff00';
                }
                else if (quality === 3) {
                    ahref.style.color = '#0070dd';
                }
                else if (quality === 4) {
                    ahref.style.color = '#a335ee';
                }
                else if (quality === 7) {
                    ahref.style.color = '#e5cc80';
                }
            }
        }

        $('#btn_search').on('click', function () {
            runGetitems($('#search').val());
        });
        function myJsonMethod(response){
            console.log (response);
        }


    }
    function myJsonMethod(response){
        console.log (response);
    }

</script>

</br>
<div style="padding-left: 50px">
    <input type="text" name="search" id="search" style="width: 200px; height: 20px"/>
    </br>
    <input type="button" id="btn_search" name="btn_search" value="Search" style="width: 70px"/>
</div>


<div id="tbl" style="background-color:black;padding-left: 50px;padding-top: 30pt;display:none;">
    <table id="table" border="1">
        <thead>
        <th>
            name
        </th>
        <th>
            ilvl
        </th>
        <th>
            seller
        </th>
        <th>
            bid
        </th>
        <th>
            buyout
        </th>
        <th>
            PPI
        </th>
        <th>
            quantity
        </th>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>
</body>
</html>
